name: 'oci-image-builder'

trigger: none  # Prevent manual/automatic trigger from commits

resources:
  pipelines:
    - pipeline: buildWarPipeline
      source: devansha-optimus.spring-petclinic-buildwar  # Name of the WAR pipeline
      trigger: true                              # Automatically trigger when that pipeline completes

variables:
  ACR_NAME: azurespringapp
  ACR_LOGIN_SERVER: azurespringapp.azurecr.io
  IMAGE_NAME: springboot-app
  BUILDER: azurespringapp.azurecr.io/azure-spring-builder:latest
  AZURE_SERVICE_CONNECTION: 'RG-Devansh-POC-0041'

pool:
  vmImage: ubuntu-latest

jobs:
- job: BuildAndPushImage
  displayName: 'Build and Push OCI Image'
  steps:

    - task: DownloadPipelineArtifact@2
      displayName: 'Download WAR Artifact'
      inputs:
        source: buildWarPipeline        # References the resource pipeline above
        artifact: springboot-war        # Must match the name used in PublishBuildArtifacts
        path: '$(Pipeline.Workspace)/war-artifact'

    - script: |
        echo "Installing pack CLI..."
        curl -sSL "https://github.com/buildpacks/pack/releases/latest/download/pack-linux.tgz" | tar -xz
        sudo mv pack /usr/local/bin/
      displayName: 'Install pack CLI'

    - task: AzureCLI@2
      displayName: 'Login to ACR'
      inputs:
        azureSubscription: $(AZURE_SERVICE_CONNECTION)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az acr login --name $ACR_NAME
      env:
        ACR_NAME: $(ACR_NAME)

    - script: |
        echo "Finding WAR file..."
        WAR_FILE=$(find $(Pipeline.Workspace)/war-artifact -name "*.war" | head -n 1)
        echo "WAR file located: $WAR_FILE"

        echo "Building OCI image using Paketo Buildpacks..."
        pack build $ACR_LOGIN_SERVER/$IMAGE_NAME:$(Build.BuildId) \
          --path $WAR_FILE \
          --builder $BUILDER \
          --publish

        echo "Tagging image as latest..."
        docker tag $ACR_LOGIN_SERVER/$IMAGE_NAME:$(Build.BuildId) $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
        docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
      displayName: 'Build and Push OCI Image'
      env:
        ACR_LOGIN_SERVER: $(ACR_LOGIN_SERVER)
        IMAGE_NAME: $(IMAGE_NAME)
        BUILDER: $(BUILDER)
