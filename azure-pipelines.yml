trigger: none  # Triggered via pipeline resource, not code push

resources:
  pipelines:
    - pipeline: buildWarPipeline
      source: devansha-optimus.spring-petclinic-buildwar
      trigger: true        # Auto-trigger when WAR pipeline completes
      branch: main

variables:
  ACR_NAME: azurespringapp
  ACR_LOGIN_SERVER: azurespringapp.azurecr.io
  IMAGE_NAME: springboot-app
  BUILDER: azurespringapp.azurecr.io/azure-spring-builder:latest
  AZURE_SERVICE_CONNECTION: 'RG-Devansh-POC-0041'

pool:
  vmImage: ubuntu-latest

jobs:
  - job: BuildAndPushImage
    displayName: Build and Push OCI Image from WAR
    steps:
      - checkout: none  # We only need artifacts, not repo code

      - task: DownloadPipelineArtifact@2
        displayName: 'Download WAR Artifact'
        inputs:
          artifact: 'springboot-war'  # Must match exactly
          path: '$(Pipeline.Workspace)/war-artifact'


      - script: |
          echo "Installing pack CLI..."
          curl -L "https://github.com/buildpacks/pack/releases/latest/download/pack-linux.tgz" | tar -xz
          sudo mv pack /usr/local/bin/
        displayName: 'Install pack CLI'

      - task: AzureCLI@2
        displayName: 'Login to ACR'
        inputs:
          azureSubscription: $(AZURE_SERVICE_CONNECTION)
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            echo "Logging in to ACR: $ACR_NAME"
            az acr login --name $ACR_NAME

      - script: |
          WAR_FILE=$(find $(Pipeline.Workspace)/war-artifact -name "*.war" | head -n 1)
          echo "WAR file located at: $WAR_FILE"

          echo "Building image using Paketo builder..."
          pack build $ACR_LOGIN_SERVER/$IMAGE_NAME:$(Build.BuildId) \
            --path $WAR_FILE \
            --builder $BUILDER \
            --publish

          echo "Tagging image as latest..."
          docker tag $ACR_LOGIN_SERVER/$IMAGE_NAME:$(Build.BuildId) $ACR_LOGIN_SERVER/$IMAGE_NAME:latest

          echo "Pushing latest tag..."
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
        displayName: 'Build and Push OCI Image'
        env:
          ACR_LOGIN_SERVER: $(ACR_LOGIN_SERVER)
          IMAGE_NAME: $(IMAGE_NAME)
          BUILDER: $(BUILDER)
